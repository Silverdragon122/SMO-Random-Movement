name: CMake

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Copy files to container
      run: |
        docker create --name temp_container devkitpro/devkitA64
        docker cp subsdk9 main.npdm temp_container:/workdir
    - name: Run build in devkitpro container
      run: |
        docker run --rm -v ${{github.workspace}}:/workdir -w /workdir devkitpro/devkitA64 cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain.cmake
        docker run --rm -v ${{github.workspace}}:/workdir -w /workdir devkitpro/devkitA64 cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
        docker run --rm -v ${{github.workspace}}:/workdir -w /workdir devkitpro/devkitA64 ctest -C ${{env.BUILD_TYPE}}
    - name: Package Files
      run: |
        cd ${{github.workspace}}/build
        zip -r ${{github.workspace}}/build/output.zip subsdk9 main.npdm
    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: output.zip
        path: ${{github.workspace}}/build/output.zip
